% 표준편차 계산 테스트
% 사용자가 제공한 데이터로 실제 std 계산

% 제공된 전류 데이터
I_data = [
-1.124900000000000
7.033000000000000
7.035600000000000
7.036400000000000
7.036700000000000
7.037000000000000
7.037100000000000
7.037200000000000
7.037300000000000
7.037400000000000
7.037400000000000
7.945000000000000
7.948700000000000
7.949100000000000
7.949300000000000
7.949400000000000
7.949400000000000
7.949500000000000
7.949500000000000
7.949500000000000
7.949500000000000
8.551600000000001
8.554900000000000
8.555199999999999
8.555300000000001
8.555400000000001
8.555500000000000
8.555500000000000
8.555600000000000
8.555600000000000
8.555600000000000
8.983900000000000
8.986900000000000
8.987200000000000
8.987299999999999
8.987399999999999
8.987399999999999
8.987399999999999
8.987500000001
8.987500000001
8.987500000001
9.146699999999999
9.149100000001
9.149300000000000
9.149400000000000
9.149400000000000
9.149500000000000
9.149500000000000
9.149500000000000
9.149500000000000
9.149500000000000
9.222400000000000
9.224200000000000
9.224399999999999
9.224500000001
9.224500000001
9.224500000001
9.224500000001
9.224500000001
9.224500000001
9.224500000001
9.224500000001
9.224500000001
9.224500000001
9.224500000001
9.224500000001
9.224500000001
9.224500000001
9.224500000001
9.224500000001
9.224500000001
9.224500000001
9.182900000000000
9.180999999999999
9.180800000000000
9.180700000000000
9.180700000000000
9.180700000000000
9.180600000000000
9.180600000000000
9.180600000000000
9.180600000000000
9.198100000000000
9.199299999999999
9.199500000000000
9.199500000000000
9.199600000000000
9.199600000000000
9.199600000000000
9.199600000000000
9.199600000000000
9.199600000000000
9.253600000000000
9.255400000000000
9.255500000000000
9.255599999999999
9.255599999999999
9.255599999999999
9.255599999999999
9.255599999999999
9.255599999999999
9.255599999999999
9.255599999999999
9.255599999999999
9.255599999999999
8.916499999999999
8.913000000000000
8.912800000001
8.912699999999999
8.912599999999999
8.912599999999999
8.912599999999999
8.912500000000000
8.912599999999999
8.912599999999999
6.876000000000000
6.881700000000000
6.881200000000000
6.881000000000000
6.880800000000000
6.880700000000000
6.880700000000000
6.880700000000000
6.880600000000000
6.880600000000000
];

% 결과를 파일로 저장
output_file = 'std_calculation_result.txt';
fid = fopen(output_file, 'w');
if fid == -1
    error('Cannot open output file');
end

fprintf('=== 표준편차 계산 테스트 ===\n\n');
fprintf(fid, '=== 표준편차 계산 테스트 ===\n\n');

% 전체 데이터 길이
n_total = length(I_data);
fprintf('전체 데이터 개수: %d\n', n_total);

% 필터링 조건 확인
Cnom = 64;  % [Ah]
max_I_std = Cnom * 0.02;  % 1.28 A
fprintf('필터링 임계값 (max_I_std): %.3f A\n\n', max_I_std);

% idx2 계산 (I_seg의 길이)
idx2 = n_total;  % 전체 길이

% 필터링 구간: I_seg(3:idx2-2)
% 즉, 처음 2개와 마지막 2개를 제외한 중간 부분
if idx2 > 4
    I_filtered = I_data(3:idx2-2);
    n_filtered = length(I_filtered);
    
    fprintf('필터링 구간: 인덱스 3 ~ %d (처음 2개, 마지막 2개 제외)\n', idx2-2);
    fprintf('필터링된 데이터 개수: %d\n', n_filtered);
    fprintf('필터링된 데이터 범위: %.3f ~ %.3f A\n', min(I_filtered), max(I_filtered));
    fprintf('필터링된 데이터 평균: %.3f A\n', mean(I_filtered));
    
    % 표준편차 계산
    current_std = std(I_filtered);
    fprintf('\n=== 계산 결과 ===\n');
    fprintf('표준편차 (std): %.6f A\n', current_std);
    fprintf('임계값 (max_I_std): %.6f A\n', max_I_std);
    
    if current_std < max_I_std
        fprintf('\n결과: %.6f < %.6f → 이벤트로 통과됨 ✓\n', current_std, max_I_std);
    else
        fprintf('\n결과: %.6f >= %.6f → 이벤트로 거부됨 ✗\n', current_std, max_I_std);
    end
    
    % 추가 분석
    fprintf('\n=== 추가 분석 ===\n');
    fprintf('전체 데이터 범위: %.3f ~ %.3f A (범위: %.3f A)\n', ...
        min(I_data), max(I_data), max(I_data) - min(I_data));
    fprintf('필터링된 데이터 범위: %.3f ~ %.3f A (범위: %.3f A)\n', ...
        min(I_filtered), max(I_filtered), max(I_filtered) - min(I_filtered));
    
    % 단계별 변화 확인
    diff_I = diff(I_filtered);
    max_diff = max(abs(diff_I));
    fprintf('연속 샘플 간 최대 변화량: %.6f A\n', max_diff);
    
    % 단계 변화 지점 찾기 (변화량이 0.1A 이상인 지점)
    large_changes = find(abs(diff_I) > 0.1);
    fprintf('큰 변화 지점 개수 (|diff| > 0.1A): %d\n', length(large_changes));
    if ~isempty(large_changes)
        fprintf('큰 변화 지점 인덱스: ');
        fprintf('%d ', large_changes);
        fprintf('\n');
        fprintf('큰 변화량: ');
        fprintf('%.3f ', diff_I(large_changes));
        fprintf('A\n');
    end
    
else
    fprintf('경고: 데이터가 너무 짧아서 필터링할 수 없습니다 (idx2 <= 4)\n');
end

